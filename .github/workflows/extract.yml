name: Extract Streaming Manifests

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Target stream page URL"
        required: true

  schedule:
    - cron: "*/6 * * * *"   # every 6 hours

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install playwright
          npx playwright install chromium
          npx playwright install-deps

      - name: Run stream extractor
        env:
          TARGET_URL: ${{ github.event.inputs.url }}
        run: node extract.js

      - name: List files (debug)
        run: |
          echo "Files in directory:"
          ls -la
          echo "Checking for JSON files:"
          ls -la *.json || echo "No JSON files found"

      - name: Commit results
        run: |
          git config user.name "stream-extractor-bot"
          git config user.email "bot@github.com"
          
          # Check which JSON files were created
          if [ -f "stream-manifests.json" ]; then
            echo "Found stream-manifests.json"
            git add stream-manifests.json
          elif [ -f "m3u8.json" ]; then
            echo "Found m3u8.json (legacy)"
            git add m3u8.json
          else
            echo "ERROR: No JSON output file created!"
            exit 1
          fi
          
          # Check if there are any staged changes
          if ! git diff --cached --quiet; then
            git commit -m "Update streaming manifests $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Create summary
        if: always()
        run: |
          echo "# Streaming Manifest Extraction Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check which file to use
          if [ -f "stream-manifests.json" ]; then
            JSON_FILE="stream-manifests.json"
            echo "## ðŸ“Š Extraction Summary (Dual format)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Source URL:** $(jq -r '.source' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "- **HLS (M3U8) URLs found:** $(jq '.totals.m3u8' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "- **DASH (MPD) URLs found:** $(jq '.totals.mpd' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "- **Total URLs:** $(jq '.totals.total' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "- **Extraction time:** $(jq -r '.timestamp' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show HLS URLs if found
            HLS_COUNT=$(jq '.totals.m3u8' $JSON_FILE)
            if [ "$HLS_COUNT" -gt 0 ]; then
              echo "### ðŸŽ¬ HLS (M3U8) URLs" >> $GITHUB_STEP_SUMMARY
              jq -r '.hls.urls[]' $JSON_FILE | while read url; do
                echo "- \`$url\`" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show DASH URLs if found
            DASH_COUNT=$(jq '.totals.mpd' $JSON_FILE)
            if [ "$DASH_COUNT" -gt 0 ]; then
              echo "### ðŸ“¦ DASH (MPD) URLs" >> $GITHUB_STEP_SUMMARY
              jq -r '.dash.urls[]' $JSON_FILE | while read url; do
                echo "- \`$url\`" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
          elif [ -f "m3u8.json" ]; then
            JSON_FILE="m3u8.json"
            echo "## ðŸ“Š Extraction Summary (Legacy format)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Source URL:** $(jq -r '.source' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "- **Total URLs found:** $(jq '.total' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "- **Extraction time:** $(jq -r '.timestamp' $JSON_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show URLs if found
            URL_COUNT=$(jq '.total' $JSON_FILE)
            if [ "$URL_COUNT" -gt 0 ]; then
              echo "### ðŸŽ¬ Extracted URLs" >> $GITHUB_STEP_SUMMARY
              jq -r '.m3u8[]' $JSON_FILE | while read url; do
                echo "- \`$url\`" >> $GITHUB_STEP_SUMMARY
              done
            fi
            
          else
            echo "## âŒ Extraction Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No JSON output file was created." >> $GITHUB_STEP_SUMMARY
            echo "Check the logs for possible errors." >> $GITHUB_STEP_SUMMARY
          fi
